

<!DOCTYPE html>
<html>
	<head>
		<title>CarePortal Pebble Settings</title> 
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1"> 
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css" />
		<script src="http://code.jquery.com/jquery-2.1.1.js"></script>
		<script src="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>

		<style type='text/css'>
			.hidden {display: none; }
			#divs div { display:none; }
		</style>

	</head>
	<body>
		<div data-role="page" id="main">
			 <div data-role="header" class="jqm-header">
				<h2>Pebble Settings</h2>
				<tt class="hidden" id="status"></tt>
			</div>

			<div data-role="fieldcontain">
				<fieldset data-role="controlgroup" id="Radio_Options" data-type="horizontal" >
					<legend><strong>Choose mg/dl or mmol:</strong></legend>
					<input name="radio_units" type="radio" id="mgdl_form" onchange="onchange_handler(this, 'mgdl');" onmouseup="onchange_handler(this, 'mgdl');" value="mgdl_form"/>
					<label for="mgdl_form">mg/dl</label>
					<input type="radio" name="radio_units" id="mmol_form" value="mmol_form" onchange="onchange_handler(this, 'mmol');" onmouseup="onchange_handler(this, 'mmol');">
					<label for="mmol_form">mmol</label>
				</fieldset>
			</div>

			<div data-role="fieldcontain">
				<label for="endpoint">
					<strong>
						Enter Data Endpoint:
					</strong>
				<input type="text" name="endpoint" id="endpoint" />
				<div id="message">
					ie:http://name.azurewebsites.net/api/v1/treatments/
				</div>
			</div>
				  
			<div data-role="fieldcontain">
				<label for="pebblename">
				<strong>
					Enter Pebble Name:
				</strong>
				<input type="text" name="pebblename" id="pebblename" />
			</div>
			<div data-role="fieldcontain">
				<label for="Secret API">
				<strong>
					Enter Secret API:
				</strong>
				<input type="text" name="secretAPI" id="secretAPI" />
			</div>
			<div class="ui-body ui-body-b">
				<fieldset class="ui-grid-a">
					<div class="ui-block-a"><button type="submit" data-theme="d" id="b-cancel">Cancel</button></div>
					<div class="ui-block-b"><button type="submit" data-theme="a" id="b-submit">Submit</button></div>
				</fieldset>
			</div>
		</div>
		<script type='text/javascript'>
			$(window).load(function(){
			if (console && console.log && console.log.call) {
				  } else {
					window.console = { log: function ( ) {
						$('#status').text([ ].slice.call(arguments).join(' '));
					  }
					};
				  }

				  $('#status').text('initializing');
				  function saveOptions() {
					$('#status').text('prepping save');
					var options = {
						'endpoint': $("#endpoint").val(),
						'pebblename' : $("#pebblename").val(),
						'secretAPI' : $("#secretAPI").val(),
						'radio' : $('input[name=radio_units]:checked').val(),
					}
					try {
					  if (window.localStorage && window.localStorage.setItem) {
						window.localStorage.setItem('cgmOpts', JSON.stringify(options));
					  } else {
						window.localStorage.cgmOpts =  JSON.stringify(options);
					  }
					} catch (e) {
					  console.log('err', e);
					  options.error = e;
					}
					$('#status').text(['prepped', JSON.stringify(options)].join(' '));
					return options;
				  }
				  function loadDefaults() {
					var _raw = null;
					var opts = { };
					_raw = window.localStorage && window.localStorage.cgmOpts
						? window.localStorage.cgmOpts : null;
					opts = (_raw && _raw.length && _raw.length > 5 ? JSON.parse(_raw) : { });
					$("#endpoint").val(opts && opts.endpoint ? opts.endpoint : '');
					$("#pebblename").val(opts && opts.t1name ? opts.t1name : '');
					$("input[value='mmol_form']").attr("checked",false).checkboxradio("refresh");
					$("input[value='mgdl_form']").attr("checked",true).checkboxradio("refresh");
					document.getElementById('mgdl_form_fields').style.display = 'block';
					document.getElementById('mmol_form_fields').style.display = 'none';
				  }
				  
				  function getOptions() {
					$('#status').text('fetching from localStorage');
					var _raw = null;
					var opts = { };
					
					if(window.localStorage.cgmOpts){
						_raw = window.localStorage && window.localStorage.cgmOpts
							? window.localStorage.cgmOpts : null;
						opts = (_raw && _raw.length && _raw.length > 5 ? JSON.parse(_raw) : { });
						$('#status').text(['has opts', JSON.stringify(opts)].join(' '));
						console.log("opts", JSON.stringify(opts));
						$("#endpoint").val(opts && opts.endpoint ? opts.endpoint : '');
						$("#pebblename").val(opts && opts.t1name ? opts.t1name : '');
						if (opts.radio == 'mgdl_form'){
							$("input[value='" + opts.radio + "']").attr("checked",true).checkboxradio("refresh");
							document.getElementById('mgdl_form_fields').style.display = 'block';
							document.getElementById('mmol_form_fields').style.display = 'none';
							$("#mglowbg").val(opts.lowbg).selectmenu("refresh");
							$("#mghighbg").val(opts.highbg).selectmenu("refresh");
						} else {
							$("input[value='mgdl_form']").attr("checked",false).checkboxradio("refresh");
							document.getElementById('mmol_form_fields').style.display = 'block';
							document.getElementById('mgdl_form_fields').style.display = 'none';
							$("input[value='" + opts.radio + "']").attr("checked",true).checkboxradio("refresh");
							$("#mmlowbg").val(opts.lowbg).selectmenu("refresh");
							$("#mmhighbg").val(opts.highbg).selectmenu("refresh");
						}
					}else{
						console.log("no data");
						$('#status').text('no data');
						loadDefaults();
					}
					
				}

				  $().ready(function() {
					if (window.location.hash.indexOf("debug") > -1) {
					  $('#status').removeClass('hidden');
					}
					$('#status').text('ready');
					$('#status').text('setting up events');
					//localStorage.clear();
					

					$("#b-cancel").click(function() {
					  console.log("Cancel");
					  $('#status').text('canceling');
					  document.location = "pebblejs://close";
					});

					$("#b-submit").click(function() {
					  console.log("Submit");
					  $('#status').text('submitting');

					  var location = "pebblejs://close#" + encodeURIComponent(JSON.stringify(saveOptions()));
					  console.log("Warping to: " + location);
					  $('#status').text('closing');
					  document.location = location;
					  // console.log('saved', window.localStorage.cgmOpts);
					});
					
					$("#b-default").click(function() {
						console.log("Default");
						localStorage.clear();
						loadDefaults();
					});
				  });
				  $('#main').bind('pageinit', getOptions());
			});
			function onchange_handler(obj, id) {
				var other_id = (id == 'mgdl')? 'mmol' : 'mgdl';
				if(obj.checked) {
					document.getElementById(id + '_form').style.display = 'block';
					document.getElementById(other_id + '_form').style.display = 'none';
				} else {
					document.getElementById(id + '_form').style.display = 'none';
					document.getElementById(other_id + '_form').style.display = 'block';
				}
			}
		</script>
	</body>
</html>
